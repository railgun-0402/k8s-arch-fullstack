version: "3.9"
services:
  app:
    image: alpine:3.20
    # ファイルに一定の文字列を記載するだけ
    command: >
      sh -c 'mkdir -p /logs &&
        while :; do
          echo "$(date -Iseconds) level=info msg=\"hello from app\" user_id=$$RANDOM";
          sleep 1;
        done >> /logs/app.log'
    volumes:
      - logs:/logs

  fluent-bit:
    image: cr.fluentbit.io/fluent/fluent-bit:4.0.10
    environment:
      AWS_REGION: ap-northeast-1
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
    volumes:
      - logs:/logs:ro
      - ./fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf:ro
      - fb-buf:/buffers
    depends_on:
      - app

volumes:
  logs:
  fb-buf:
